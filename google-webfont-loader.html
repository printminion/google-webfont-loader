<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>

<!--
Element providing google font loading functionality and throws an "fonts-active" event after all fonts are loaded.

Example:

    <google-webfont-loader fonts="Droid Sans, Oswald, Lobster"></google-webfont-loader>

@demo
-->
<dom-module id="google-webfont-loader">

    <style>
        :host {
            display: block;
            box-sizing: border-box;
        }

    </style>

</dom-module>

<script>
    (function() {

        var WebFontConfig_ = {};

        Polymer({

        is: 'google-webfont-loader',

        properties: {

            /**
             * Fired when all fonts are loaded and available.
             * @event fonts-active
             */
            /**
             * Fired when particular font is loaded and available.
             * @event font-active
             */
            /**
             * The `fonts` attribute sets a list of fonts to load
             *
             * @attribute fonts
             * @type Array
             * @default ['Droid Sans']
             */
            fonts: {
                type: Array,
                value: function () {
                    return ['Droid Sans'];
                },
                notify: true
            },


            /**
             * Loaded fonts
             *
             * @attribute fonts
             * @type Array
             */
            _fonts_loaded: []

        },

        // Element Lifecycle

        ready: function () {
            // `ready` is called after all elements have been configured, but
            // propagates bottom-up. This element's children are ready, but parents
            // are not.
            //
            // This is the point where you should make modifications to the DOM (when
            // necessary), or kick off any processes the element wants to perform.

            console.log('ready to load', this.fonts, this);
            this._fonts_loaded = [];
            this.fonts = this.fonts.split(/,[\s]+/);

            console.log('ready', this.fonts);

            WebFontConfig_ = {
                active: function () {
                   this.fontsAreActive()
                }.bind(this),
                loading: function () {
                    console.log('WebFont:loading');
                },
                fontactive: function (fontactive, fvd) {
                    this._fonts_loaded.push(fontactive);
                    console.log('WebFont:fontactive', fontactive);
                    this.fontIsActive(fontactive);
                }.bind(this),
                google: {
                    families: this.fonts
                }
            };

            if (this.fonts.length > 0) {
                WebFont.load(WebFontConfig_);
            }
        },

        attached: function () {
            // `attached` fires once the element and its parents have been inserted
            // into a document.
            //
            // This is a good place to perform any work related to your element's
            // visual state or active behavior (measuring sizes, beginning animations,
            // loading resources, etc).
        },

        detached: function () {
            // The analog to `attached`, `detached` fires when the element has been
            // removed from a document.
            //
            // Use this to clean up anything you did in `attached`.
        },

        /**
         * Get loaded fonts
         */
        getLoadedFonts: function() {
            return this._fonts_loaded;
        },
        /**
         * check if font is loaded
         */
        isFontLoaded: function(font) {
            this._fonts_loaded.every(function(index, value) {
                if (font == value) {
                    return true;
                }
            });
        },
        // Element Behavior
        /**
         * Dispatches an event that font is active
         */
        fontIsActive: function(font) {
            this.fire('font-active', {font: font});
        },
        /**
         * Dispatches an event that font is active
         */
        fontsAreActive: function() {
            console.log('WebFonts: fontsactive', this._fonts_loaded);
            this.fire('fonts-active', {fonts: this._fonts_loaded});
        }
    });

    })();

</script>

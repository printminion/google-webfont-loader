<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="webfontloader-import.html">

<!--
Element providing google font loading functionality and throws an "fonts-active" event after all fonts are loaded.

Example:

    <google-webfont-loader fonts="Droid Sans, Oswald, Lobster"></google-webfont-loader>

@demo
-->
<dom-module id="google-webfont-loader">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>
    </template>

    <script>
        (function () {
            // Run once. Private and static to the element.
            let WebFontConfig_ = {};


            // these variables are shared by all instances of app-globals
            let values = {
                fonts_loaded: [],
                fonts_added: []
            };


            /**
             * `google-webfont-loader`
             * A polymer element providing solution for catching google webfonts active (loaded) event
             *
             * @customElement
             * @polymer
             * @demo demo/index.html
             */
            class GoogleWebfontLoader extends Polymer.Element {

                static get is() {
                    return 'google-webfont-loader';
                }

                static get properties() {
                    return {
                        /**
                         * The `fonts` attribute sets a list of fonts to load comma separated
                         *
                         * @attribute fonts
                         * @type Array
                         * @default 'Droid Sans'
                         */
                        fonts: {
                            type: String,
                            observer: '_fontsChanged'
                        }
                    };
                }


                constructor() {
                    super();
                    this._fonts_added = [];
                    console.log(this.localName + '#' + this.id + ' was created');
                }


                _fontsChanged(newValue, oldValue) {
                    console.log('_fontsChanged', newValue, oldValue);

                    values.fonts_added = newValue.split(/,[\s]*/);
                    values._fonts_added = newValue.split(/,[\s]*/);


                }

                ready() {
                    // make global values available on instance.
                    this.values = values;
                    console.log(this.localName + '#' + this.id + ' is ready');
                    this._init();
                }

                connectedCallback() {
                    console.log(this.localName + '#' + this.id + ' was attached');
                    this._init();
                }

                disconnectedCallback() {
                    console.log(this.localName + '#' + this.id + ' was detached');
                }

                attributeChangedCallback(name, type) {
                    console.log(this.localName + '#' + this.id + ' attribute "' + name +
                        '" was changed to ' + this.getAttribute(name));

                    if (name === 'fonts') {
                        let newValue = this.getAttribute(name);
                        this._fontsChanged(newValue, newValue)
                    }
                }

                _init() {
                    // `ready` is called after all elements have been configured, but
                    // propagates bottom-up. This element's children are ready, but parents
                    // are not.
                    //
                    // This is the point where you should make modifications to the DOM (when
                    // necessary), or kick off any processes the element wants to perform.

                    console.log('ready to load', values.fonts_added, this);

                    WebFontConfig_ = {
                        active: function () {
                            console.log('WebFont:active');
                            this.fontsAreActive()
                        }.bind(this),
                        loading: function () {
                            console.log('WebFont:loading');
                        },
                        fontactive: function (fontactive, fvd) {
                            console.log('WebFont:fontactive');

                            this.fontIsActive(fontactive);
                        }.bind(this),
                        google: {
                            families: values.fonts_added
                        }
                    };

                    if (values.fonts_added.length > 0) {
                        WebFont.load(WebFontConfig_);
                    }
                }

                /**
                 * Get loaded fonts
                 */
                getLoadedFonts() {
                    return this.values.fonts_loaded;
                }

                /**
                 * check if font is loaded
                 */
                isFontLoaded(font) {
                    this.values.fonts_loaded.every(function (index, value) {
                        if (font === value) {
                            return true;
                        }
                    });
                }

                // Element Behavior
                /**
                 * Dispatches an event that font is active
                 */
                fontIsActive(font) {
                    console.log('WebFont:fontactive', font);
                    values.fonts_loaded.push(font);

                    this.dispatchEvent(new CustomEvent('font-active', {detail: {font: font}}));
                }

                /**
                 * Dispatches an event that font is active
                 */
                fontsAreActive() {
                    console.log('WebFonts: fontsactive', values.fonts_loaded);

                    this.dispatchEvent(new CustomEvent('fonts-active', {detail: {fonts: values.fonts_loaded}}));
                }
            }

            window.customElements.define(GoogleWebfontLoader.is, GoogleWebfontLoader);
        })();
    </script>
</dom-module>
